import os
import pandas as pd

# âœ… Define the correct breakout log file path
LOG_FILE = os.path.expanduser("~/Documents/breakout_log.csv")

# âœ… Ensure the file exists
if not os.path.exists(LOG_FILE):
    print("âŒ No breakout log file found. Run the bot first!")
    exit()

# âœ… Correct column headers based on your log file format
columns = ["timestamp", "symbol", "entry_price", "target_price", "stop_loss"]

# âœ… Read CSV with explicit column names
df = pd.read_csv(
    LOG_FILE,
    names=columns,  
    header=None,  
    parse_dates=["timestamp"],  
    dtype={"symbol": str, "entry_price": float, "target_price": float, "stop_loss": float}
)

# âœ… Drop rows where timestamp parsing failed
df.dropna(subset=["timestamp"], inplace=True)

# âœ… Ensure timestamps are in UTC
df["timestamp"] = pd.to_datetime(df["timestamp"], errors="coerce", utc=True)

# âœ… Debugging: Show timestamp range
print(f"ğŸ•’ Newest breakout timestamp: {df['timestamp'].max()}")
print(f"ğŸ•’ Oldest breakout timestamp: {df['timestamp'].min()}")

# âœ… Sort data from newest to oldest
df = df.sort_values(by="timestamp", ascending=False)

# âœ… Verify sorting works correctly
print(f"âœ… Sorted: First timestamp in dataset: {df.iloc[0]['timestamp']}")
print(f"âœ… Sorted: Last timestamp in dataset: {df.iloc[-1]['timestamp']}")

# âœ… Calculate breakout success rate
df["previous_high"] = df.groupby("symbol")["price"].shift(1)
df["success"] = df["price"] > df["previous_high"]
success_rate = df["success"].mean() * 100

# âœ… Summary Statistics
df["hit_target"] = df["entry_price"] <= df["target_price"]
df["hit_stop"] = df["entry_price"] >= df["stop_loss"]

df["profit"] = df["hit_target"] * (df["target_price"] - df["entry_price"]) - df["hit_stop"] * (df["entry_price"] - df["stop_loss"])

total_profit = df["profit"].sum()
win_rate = df["hit_target"].mean() * 100  # % of trades that hit target price

# âœ… Print updated statistics
print("\nğŸ“Š **Breakout Performance & Profitability Summary**")
print(f"ğŸ”¹ Total Breakouts: {len(df)}")
print(f"âœ… Winning Trades: {df['hit_target'].sum()} ({win_rate:.2f}%)")
print(f"âŒ Stopped Out Trades: {df['hit_stop'].sum()}")
print(f"ğŸ’° Estimated Total Profit: {total_profit:.4f} (assumes 1 unit per trade)")

# âœ… Display best-performing assets
best_assets = df[df["success"] == True]["symbol"].value_counts().head(5)
if not best_assets.empty:
    print("\nğŸš€ Best Performing Assets:")
    print(best_assets)

# âœ… Display worst-performing assets
worst_assets = df[df["success"] == False]["symbol"].value_counts().head(5)
if not worst_assets.empty:
    print("\nâš ï¸ Worst Performing Assets:")
    print(worst_assets)

# âœ… Save Analysis to CSV
output_file = os.path.expanduser("~/Documents/breakout_analysis.csv")
df.to_csv(output_file, index=False)
print(f"\nğŸ“‚ Analysis saved to '{output_file}'")

